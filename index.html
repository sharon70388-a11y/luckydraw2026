import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Plus, Trash2, X, Play, Square, RotateCcw } from 'lucide-react';

// --- è‰²ç¥¨å®šç¾© (å¾©å¤ç´…ç™½è—) ---
const COLORS = [
  '#C62828', // å¾©å¤ç´…
  '#F5F5F5', // ç±³ç™½
  '#1565C0', // å¾©å¤è—
];
const GOLD = '#FFD700'; // é‡‘è‰²
const GOLD_DARK = '#B7950B'; // æ·±é‡‘è‰²

export default function App() {
  // --- ç‹€æ…‹ç®¡ç† ---
  // é è¨­è³‡æ–™ï¼š2æ¬„10åˆ— (æ­¤è™•å…ˆé å¡«å¹¾ç­†ç¯„ä¾‹ï¼Œå…¶é¤˜ç‚ºç©º)
  const generateInitialData = () => {
    const data = Array.from({ length: 10 }, (_, i) => ({
      id: Date.now() + i,
      name: i === 0 ? 'é™³èªå®¸' : i === 1 ? 'é™³å°æ˜' : '',
      value: i === 0 ? 20000 : i === 1 ? 4 : '',
      color: COLORS[i % COLORS.length]
    }));
    return data;
  };

  const [items, setItems] = useState(generateInitialData);
  const [unit, setUnit] = useState('è¬å…ƒ'); // é è¨­å–®ä½
  const [title, setTitle] = useState('å¹¸é‹è½‰ç›¤');
  const [isSpinning, setIsSpinning] = useState(false);
  const [isStopping, setIsStopping] = useState(false);
  const [rotation, setRotation] = useState(0); // ç¸½æ—‹è½‰è§’åº¦
  const [winner, setWinner] = useState(null); // ä¸­çè€…è³‡è¨Š
  const [showModal, setShowModal] = useState(false);

  // Canvas åƒè€ƒ
  const canvasRef = useRef(null);
  const requestRef = useRef();
  const speedRef = useRef(0);
  const stoppingStartTimeRef = useRef(0);
  const initialStoppingSpeedRef = useRef(0);

  // --- è¨ˆç®—é‚è¼¯ ---

  // è¨ˆç®—æœ‰æ•ˆé …ç›®çš„ç¸½å€¼ (æ’é™¤ç©ºå€¼æˆ–éæ•¸å­—)
  const getTotal = useCallback(() => {
    return items.reduce((sum, item) => {
      const val = parseFloat(item.value);
      return sum + (isNaN(val) ? 0 : val);
    }, 0);
  }, [items]);

  // è¨ˆç®—æ¯å€‹é …ç›®çš„è§’åº¦ç¯„åœ
  const getSlices = useCallback(() => {
    const total = getTotal();
    let currentAngle = 0;
    const validItems = items.filter(i => parseFloat(i.value) > 0 && i.name.trim() !== '');
    
    // å¦‚æœæ²’æœ‰æœ‰æ•ˆè³‡æ–™ï¼Œå›å‚³ç©º
    if (total === 0 || validItems.length === 0) return [];

    return validItems.map((item, index) => {
      const val = parseFloat(item.value);
      const angle = (val / total) * 360; // è©²é …ç›®ä½”çš„è§’åº¦
      const slice = {
        ...item,
        startAngle: currentAngle,
        endAngle: currentAngle + angle,
        color: COLORS[index % COLORS.length] // é‡æ–°åˆ†é…é¡è‰²ç¢ºä¿é€£çºŒæ€§
      };
      currentAngle += angle;
      return slice;
    });
  }, [items, getTotal]);

  // --- å‹•ç•«è¿´åœˆ ---
  const animate = useCallback((time) => {
    if (isSpinning && !isStopping) {
      // æŒçºŒæ—‹è½‰éšæ®µ
      speedRef.current = 20; // å›ºå®šé€Ÿåº¦
      setRotation(prev => (prev + speedRef.current) % 360);
      requestRef.current = requestAnimationFrame(animate);
    } else if (isStopping) {
      // åœæ­¢éšæ®µ (1.5ç§’ç·©è¡)
      if (!stoppingStartTimeRef.current) stoppingStartTimeRef.current = time;
      
      const elapsed = time - stoppingStartTimeRef.current;
      const duration = 1500; // 1.5ç§’
      
      if (elapsed < duration) {
        // ç·šæ€§æ¸›é€Ÿ
        const progress = elapsed / duration;
        // é€Ÿåº¦å¾ initial é™åˆ° 0
        const currentSpeed = initialStoppingSpeedRef.current * (1 - progress);
        
        // ä½¿ç”¨ easeOutCubic è®“åœæ­¢æ›´è‡ªç„¶ (é¸ç”¨)
        // const easeOut = 1 - Math.pow(1 - progress, 3);
        
        setRotation(prev => (prev + currentSpeed) % 360);
        requestRef.current = requestAnimationFrame(animate);
      } else {
        // å®Œå…¨åœæ­¢
        setIsSpinning(false);
        setIsStopping(false);
        determineWinner();
      }
    }
  }, [isSpinning, isStopping]);

  useEffect(() => {
    if (isSpinning) {
      requestRef.current = requestAnimationFrame(animate);
    }
    return () => cancelAnimationFrame(requestRef.current);
  }, [isSpinning, isStopping, animate]);

  // --- åˆ¤æ–·ä¸­çè€… ---
  const determineWinner = () => {
    const slices = getSlices();
    if (slices.length === 0) return;

    // æŒ‡é‡åœ¨å³ä¸Šè§’ 45åº¦ (Canvas 0åº¦æ˜¯3é»é˜ï¼Œé †æ™‚é‡)
    // è¦–è¦ºä¸Šçš„ 45åº¦ä½ç½® (1:30æ–¹å‘) å°æ‡‰ Canvas åº§æ¨™ç³»ç´„ç‚º 315åº¦ (-45åº¦)
    // ä½†ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘è¨ˆç®—ç›¸å°è§’åº¦ã€‚
    
    // æˆ‘å€‘éœ€è¦è¨ˆç®—ï¼šç•¶è½‰ç›¤åœä¸‹æ™‚ï¼Œå“ªä¸€å€‹æ‰‡å½¢å€åŸŸè½åœ¨äº†æŒ‡é‡ä¸‹æ–¹ã€‚
    // æŒ‡é‡æ˜¯å›ºå®šçš„ï¼Œè½‰ç›¤åœ¨å‹•ã€‚
    // æŒ‡é‡ä½ç½®å›ºå®šåœ¨ Canvas çš„ 270deg (12é») + 45deg = 315deg (å³ä¸Š) ?
    // è®“æˆ‘å€‘å®šç¾©æŒ‡é‡è§’åº¦ï¼š
    const POINTER_ANGLE = 315; // å³ä¸Šè§’ 45åº¦ (é€†æ™‚é‡çœ‹æ˜¯315ï¼Œé †æ™‚é‡çœ‹æ˜¯-45ï¼Œç›¸å°æ–¼3é»é˜0åº¦)
    
    // ç›®å‰è½‰ç›¤è½‰äº† rotation åº¦ã€‚
    // æŸå€‹ slice çš„ç¯„åœæ˜¯ [start, end]
    // ç¶“éæ—‹è½‰å¾Œï¼Œè©² slice çš„ç¯„åœè®Šæˆäº† [start + rotation, end + rotation]
    // æˆ‘å€‘è¦æ‰¾çš„æ˜¯ï¼šå“ªå€‹ slice åŒ…å« POINTER_ANGLE
    
    // æ­£è¦åŒ– rotation åˆ° 0-360
    const normalizedRotation = rotation % 360;
    
    // é€†æ¨ï¼šæŒ‡é‡åœ¨è½‰ç›¤ä¸Šçš„ç›¸å°ä½ç½® = (æŒ‡é‡è§’åº¦ - è½‰ç›¤æ—‹è½‰è§’åº¦)
    // éœ€è¦è™•ç†è² æ•¸ä¸¦ mod 360
    let relativePointerAngle = (POINTER_ANGLE - normalizedRotation) % 360;
    if (relativePointerAngle < 0) relativePointerAngle += 360;

    const winnerSlice = slices.find(s => 
      relativePointerAngle >= s.startAngle && relativePointerAngle < s.endAngle
    );

    if (winnerSlice) {
      setWinner(winnerSlice);
      setShowModal(true);
    }
  };

  // --- ç¹ªè£½è½‰ç›¤ ---
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const centerX = width / 2;
    const centerY = height / 2;
    const radius = Math.min(width, height) / 2 - 20; // ç•™é‚Šè·

    // æ¸…ç©ºç•«å¸ƒ
    ctx.clearRect(0, 0, width, height);

    const slices = getSlices();
    const totalValue = getTotal();

    // å„²å­˜ç•¶å‰ç‹€æ…‹ä»¥é€²è¡Œæ—‹è½‰
    ctx.save();
    ctx.translate(centerX, centerY);
    ctx.rotate((rotation * Math.PI) / 180);

    if (slices.length === 0) {
      // ç¹ªè£½ç©ºè½‰ç›¤èƒŒæ™¯
      ctx.beginPath();
      ctx.arc(0, 0, radius, 0, 2 * Math.PI);
      ctx.fillStyle = '#eee';
      ctx.fill();
      ctx.strokeStyle = '#ccc';
      ctx.stroke();
      // æ–‡å­—
      ctx.fillStyle = '#999';
      ctx.font = '20px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('è«‹è¼¸å…¥è³‡æ–™', 0, 0);
    } else {
      // ç¹ªè£½æ‰‡å½¢
      slices.forEach(slice => {
        const startRad = (slice.startAngle * Math.PI) / 180;
        const endRad = (slice.endAngle * Math.PI) / 180;

        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.arc(0, 0, radius, startRad, endRad);
        ctx.closePath();
        ctx.fillStyle = slice.color;
        ctx.fill();
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#fff';
        ctx.stroke();

        // ç¹ªè£½æ–‡å­— (åœ¨æ‰‡å½¢ä¸­é–“)
        ctx.save();
        const midRad = (startRad + endRad) / 2;
        ctx.rotate(midRad);
        ctx.translate(radius * 0.6, 0); // æ–‡å­—è·é›¢åœ“å¿ƒçš„è·é›¢
        
        // åˆ¤å®šæ–‡å­—é¡è‰²ï¼šå¦‚æœæ˜¯ç±³ç™½è‰²èƒŒæ™¯(#F5F5F5)ï¼Œå­—é«”æ”¹ç‚ºæ·±è‰²(#334155)ï¼Œå¦å‰‡ç¶­æŒç™½è‰²
        ctx.fillStyle = slice.color === '#F5F5F5' ? '#334155' : '#fff';

        // æ ¹æ“šæ‰‡å½¢å¤§å°å‹•æ…‹èª¿æ•´å­—é«” (åŠ å¤§å­—é«”)
        const angleDiff = slice.endAngle - slice.startAngle;
        let fontSize = 24; // é è¨­å­—é«”åŠ å¤§
        if (angleDiff < 15) fontSize = 14;
        else if (angleDiff < 30) fontSize = 18;
        else if (angleDiff < 45) fontSize = 20;
        
        ctx.font = `bold ${fontSize}px "Noto Sans TC", sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        // åå­— (åªé¡¯ç¤ºåå­—)
        ctx.fillText(slice.name, 0, 0);
        
        ctx.restore();
      });
    }

    ctx.restore(); // æ¢å¾©æ—‹è½‰å‰çš„ç‹€æ…‹

    // --- ç¹ªè£½æŒ‡é‡ (å›ºå®šåœ¨å³ä¸Šè§’ 45åº¦) ---
    // 45åº¦ = -45åº¦ (é€†æ™‚é‡) = 315åº¦
    const pointerAngleRad = (315 * Math.PI) / 180; 
    const pointerLen = 40;
    
    ctx.save();
    ctx.translate(centerX, centerY);
    // ç§»å‹•åˆ°åœ“å‘¨é‚Šç·£
    const px = Math.cos(pointerAngleRad) * (radius + 10);
    const py = Math.sin(pointerAngleRad) * (radius + 10);
    
    ctx.translate(px, py);
    ctx.rotate(pointerAngleRad + Math.PI); // æŒ‡å‘åœ“å¿ƒ

    // ç•«é‡‘è‰²ä¸‰è§’å½¢æŒ‡é‡
    ctx.beginPath();
    ctx.moveTo(0, 0); // å°–ç«¯ (ç¨å¾®ç¸®é€²å»ä¸€é»)
    ctx.lineTo(-15, 30);
    ctx.lineTo(15, 30);
    ctx.closePath();
    
    ctx.fillStyle = GOLD;
    ctx.fill();
    ctx.strokeStyle = GOLD_DARK;
    ctx.lineWidth = 2;
    ctx.stroke();
    
    ctx.restore();

  }, [items, rotation, getSlices, getTotal]);


  // --- æ“ä½œè™•ç† ---

  const handleStart = () => {
    if (getSlices().length === 0) {
      alert('è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„åå­—èˆ‡æ•¸å€¼ï¼');
      return;
    }
    if (isSpinning) {
      // é»æ“Šåœä¸‹
      setIsStopping(true);
      stoppingStartTimeRef.current = 0;
      initialStoppingSpeedRef.current = speedRef.current;
    } else {
      // é»æ“Šé–‹å§‹
      setWinner(null);
      setIsSpinning(true);
      setIsStopping(false);
      speedRef.current = 0;
    }
  };

  const handleInputChange = (id, field, value) => {
    setItems(prev => prev.map(item => 
      item.id === id ? { ...item, [field]: value } : item
    ));
  };

  const addRow = () => {
    setItems(prev => [
      ...prev,
      { id: Date.now(), name: '', value: '', color: '#000' }
    ]);
  };

  const deleteRow = (id) => {
    setItems(prev => prev.filter(item => item.id !== id));
  };

  const removeWinner = () => {
    if (winner) {
      deleteRow(winner.id);
      setShowModal(false);
      setWinner(null);
      // é‡ç½®è½‰ç›¤è§’åº¦ï¼Œè®“è¦–è¦ºä¸Šçœ‹èµ·ä¾†æ›´æ–°äº†
      setRotation(0);
    }
  };

  // ç¸½è¨ˆæ ¼å¼åŒ–
  const total = getTotal();

  return (
    <div className="flex h-screen w-full bg-slate-100 font-sans text-slate-800 overflow-hidden">
      
      {/* å·¦å´ï¼šè½‰ç›¤å€ (æ”¹ç‚º 70%) */}
      <div className="w-[70%] h-full flex flex-col items-center justify-center relative bg-slate-200 border-r-4 border-slate-300 shadow-inner p-4">
        
        {/* è‡ªè¨‚æ¨™é¡Œ */}
        <input 
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          className="text-4xl font-black text-slate-700 bg-transparent text-center mb-4 border-b-2 border-transparent hover:border-slate-400 focus:border-slate-500 focus:outline-none transition-colors"
          placeholder="é»æ“Šè¼¸å…¥æ¨™é¡Œ"
        />

          {/* Canvas å®¹å™¨ */}
        <div className="relative">
          {/* å¤–åœˆè£é£¾ */}
          <div className="rounded-full border-8 border-slate-300 shadow-2xl bg-white p-2">
            <canvas 
              ref={canvasRef} 
              width={600} 
              height={600} 
              className="rounded-full max-w-full h-auto"
              style={{ maxHeight: '75vh', maxWidth: '75vh' }}
            />
          </div>

          {/* ä¸­å¿ƒæŒ‰éˆ• (çµ•å°å®šä½) */}
          <button
            onClick={handleStart}
            disabled={isStopping}
            className={`
              absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2
              w-24 h-24 rounded-full border-4 shadow-xl z-10 flex flex-col items-center justify-center
              transition-all active:scale-95 hover:brightness-110
              text-white font-bold text-xl
            `}
            style={{
              backgroundColor: isSpinning ? (isStopping ? '#7f8c8d' : '#C62828') : GOLD,
              borderColor: GOLD_DARK,
              color: isSpinning ? 'white' : '#5D4037',
              textShadow: isSpinning ? 'none' : '0px 1px 0px rgba(255,255,255,0.4)'
            }}
          >
            {isSpinning ? (isStopping ? 'æ¸›é€Ÿä¸­' : 'åœä¸‹') : 'é–‹å§‹'}
            {!isSpinning && <Play size={20} className="mt-1 opacity-80" />}
            {isSpinning && !isStopping && <Square size={16} fill="white" className="mt-1" />}
          </button>
        </div>
      </div>

      {/* å³å´ï¼šè¼¸å…¥å€ (æ”¹ç‚º 30%) */}
      <div className="w-[30%] h-full flex flex-col bg-white shadow-xl z-20">
        <div className="p-6 bg-slate-800 text-white flex justify-between items-center shadow-md">
          <h2 className="text-xl font-bold flex items-center gap-2">
            <RotateCcw size={20} />
            è½‰ç›¤è¨­å®š
          </h2>
          <div className="flex items-center gap-2 text-sm">
            <span>æ•¸å€¼å–®ä½ï¼š</span>
            <input 
              value={unit} 
              onChange={(e) => setUnit(e.target.value)}
              className="w-16 px-2 py-1 rounded text-slate-800 font-bold text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
        </div>

        <div className="flex-1 overflow-y-auto p-4">
          <table className="w-full text-left border-collapse">
            <thead className="sticky top-0 bg-white shadow-sm z-10">
              <tr className="text-slate-500 border-b-2 border-slate-200">
                <th className="p-2 w-12 text-center">#</th>
                <th className="p-2">åå­—</th>
                <th className="p-2">æ•¸å€¼ ({unit})</th>
                <th className="p-2 w-20 text-right">ä½”æ¯”</th>
                <th className="p-2 w-10"></th>
              </tr>
            </thead>
            <tbody>
              {items.map((item, index) => {
                const val = parseFloat(item.value) || 0;
                const percent = total > 0 ? ((val / total) * 100).toFixed(1) : '0.0';
                
                return (
                  <tr key={item.id} className="border-b border-slate-100 hover:bg-blue-50 transition-colors group">
                    <td className="p-2 text-center text-slate-400 font-mono text-sm">{index + 1}</td>
                    <td className="p-2">
                      <input 
                        type="text"
                        value={item.name}
                        onChange={(e) => handleInputChange(item.id, 'name', e.target.value)}
                        placeholder="è¼¸å…¥åå­—"
                        className="w-full bg-transparent border border-transparent hover:border-slate-300 focus:border-blue-500 rounded px-2 py-1 outline-none transition-all"
                      />
                    </td>
                    <td className="p-2">
                      <input 
                        type="number"
                        value={item.value}
                        onChange={(e) => handleInputChange(item.id, 'value', e.target.value)}
                        placeholder="0"
                        className="w-full bg-transparent border border-transparent hover:border-slate-300 focus:border-blue-500 rounded px-2 py-1 outline-none transition-all font-mono"
                      />
                    </td>
                    <td className="p-2 text-right text-slate-600 font-medium text-sm">
                      {percent}%
                    </td>
                    <td className="p-2 text-center">
                      <button 
                        onClick={() => deleteRow(item.id)}
                        className="text-slate-300 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-red-50"
                        title="åˆªé™¤"
                      >
                        <Trash2 size={16} />
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
          
          <button 
            onClick={addRow}
            className="w-full mt-4 py-3 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 hover:text-blue-600 hover:border-blue-400 hover:bg-blue-50 transition-all flex items-center justify-center gap-2 font-medium"
          >
            <Plus size={18} /> æ–°å¢åˆ—
          </button>
        </div>

        {/* ç¸½è¨ˆ Footer */}
        <div className="p-4 bg-slate-50 border-t border-slate-200">
          <div className="flex justify-between items-center text-lg font-bold text-slate-700">
            <span>ç¸½é¡</span>
            <span className="font-mono text-2xl text-blue-800">
              {total.toLocaleString()} <span className="text-sm text-slate-500">{unit}</span>
            </span>
          </div>
          <div className="mt-2 text-xs text-slate-400 text-right">
            å…± {items.length} ç­†è³‡æ–™ï¼Œæœ‰æ•ˆ {items.filter(i => i.value > 0).length} ç­†
          </div>
        </div>
      </div>

      {/* çµæœ Modal */}
      {showModal && winner && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center animate-in fade-in duration-300">
          <div className="bg-white rounded-2xl shadow-2xl w-96 transform transition-all scale-100 p-0 overflow-hidden border-4 border-yellow-400">
            <div className="bg-yellow-400 p-4 flex justify-center items-center">
               <h3 className="text-yellow-900 font-black text-2xl tracking-widest">ğŸ‰ çµæœå‡ºçˆ ğŸ‰</h3>
            </div>
            <div className="p-8 text-center">
              <div className="text-slate-500 text-lg mb-2">æŒ‡é‡åœåœ¨äº†...</div>
              <div className="text-4xl font-black text-red-600 mb-2">{winner.name}</div>
              <div className="text-xl text-slate-600 font-medium">
                {Number(winner.value).toLocaleString()} {unit}
              </div>
              <div className="text-sm text-slate-400 mt-1">
                (ä½”æ¯” {((parseFloat(winner.value) / total) * 100).toFixed(1)}%)
              </div>
            </div>
            <div className="flex border-t border-slate-100">
              <button 
                onClick={() => setShowModal(false)}
                className="flex-1 py-4 text-slate-600 font-bold hover:bg-slate-50 transition-colors border-r border-slate-100"
              >
                ç¹¼çºŒ (ä¿ç•™)
              </button>
              <button 
                onClick={removeWinner}
                className="flex-1 py-4 text-red-600 font-bold hover:bg-red-50 transition-colors flex items-center justify-center gap-2"
              >
                <Trash2 size={18} />
                ç§»é™¤è©²äºº
              </button>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}
